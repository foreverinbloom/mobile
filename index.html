<!doctype html>
<html lang="en">
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;600;700&display=swap" rel="stylesheet">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rooted in the Word üå± | MBC</title>

  <style>
    :root{
      --border:#cfcfcf;
      --ink:#111;
      --muted:#666;
      --panel:#fff;
      --bg:#fff;
      --reflectionInk:#1E293B;
    }

    body{
      margin:0;
      background:var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color:var(--ink);
    }

    /* Only the reminder body uses Garamond */
    .garamond-text{
      font-family: "EB Garamond", Garamond, "Adobe Garamond Pro", serif;
    }

    .wrap{
      padding:14px;
      max-width:520px;
      margin:0 auto;
    }

    /* Panel */
    .revealCard{
      border:3px solid var(--ink);
      border-radius:18px;
      padding:14px;
      background:var(--panel);
      display:grid;
      gap:12px;
    }

    /* Titles / rows */
    .revealTitle{
      font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      font-weight:900;
      font-size:18px;
    }

    .keyRow,
    .practiceRow{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }

    .keyRowStacked{
      flex-direction:column;
      align-items:flex-start;
    }

    .keyLabel{
      font-weight:900;
      font-size:14px;
    }

    .btnRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .btnColumn{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:6px;
      align-items:flex-start;
    }

    button{
      -webkit-appearance:none;
      appearance:none;
      border:1px solid var(--border);
      background:#fff;
      border-radius:10px;
      padding:8px 10px;
      font-weight:700;
      cursor:pointer;
    }

    .miniBtn{
      padding:6px 8px;
      font-size:12px;
      border-radius:9px;
    }

    /* Source textarea */
    .keyInput{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      font-size:14px;
      font-weight:700;
      resize:vertical;
      min-height:120px;
      box-sizing:border-box;
    }

    .keyHiddenNote{
      border:1px dashed var(--border);
      border-radius:12px;
      padding:10px;
      font-size:14px;
      color:var(--muted);
      font-weight:700;
      background:#fafafa;
    }

    /* Divider */
    .softRule{
      border:none;
      border-top:1px solid #e5e5e5;
      margin:2px 0;
    }

    /* Instructions */
    .revealInstructions{
      font-weight:700;
      font-size:14px;
      line-height:1.45;
      margin-bottom:10px;
    }

    /* Input */
    .revealInput{
      width:100%;
      border:none;
      border-bottom:2px solid var(--ink);
      outline:none;
      font-size:16px;
      font-weight:900;
      background:transparent;
      padding:8px 2px;
    }

    .revealHint{
      color:var(--muted);
      font-weight:700;
      font-size:14px;
      letter-spacing:.02em;
    }

    /* Reveal line */
    .revealLine{
      font-size:18px;
      font-weight:900;
      line-height:1.45;
      word-wrap:break-word;
      min-height:260px;
    }

    .revealWord.hidden{ color:#bbb; }
    .revealWord.revealed{ color:#111; }

    /* Emojis */
    .emojiSpeak{
      font-size:1.4em;
      vertical-align:middle;
      margin-left:4px;
    }

    .helpToggle{
      -webkit-appearance:none;
      appearance:none;
      border:none;
      background:transparent;
      padding:0 4px;
      margin-left:6px;
      font-weight:900;
      cursor:pointer;
      color:var(--muted);
    }

    .helpTooltip{
      margin-top: 2px;
      padding: 10px 12px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: #fafafa;
      font-size: 14px;
      line-height: 1.5;
      max-width: 100%;
    }

    .helpTooltip strong{
      font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    }

    .emojiTitle{
      font-size:1.15em;
      vertical-align:middle;
      margin-left:6px;
    }

    /* Reflection */
    .reflectionPrompt{
      margin-top:10px;
      color:var(--reflectionInk);
      font-size:15px;
      line-height:1.5;
    }

    .reflectionPrompt .star{
      font-weight:900;
      margin-right:6px;
    }

    .reflectionPrompt em{
      font-style:italic;
      font-weight:800;
    }

    textarea, input { font-family:inherit; }
  </style>
</head>

<body>
  <div class="wrap">
    <section class="revealCard" aria-label="Rooted in the Word Scripture Memory Tool">

      <div class="revealTitle">
        Rooted in the Word <span class="emojiTitle" aria-hidden="true">üå±</span>
      </div>

      <!-- Verse Source -->
      <div class="keyRow keyRowStacked">
        <div class="keyLabel">Verse source (used to generate initials)</div>
        <div class="btnRow">
          <button id="clearSource" type="button" class="miniBtn">Clear</button>
          <button id="toggleKey" type="button">Hide</button>
        </div>
      </div>

      <textarea id="fullVerseKey" class="keyInput" placeholder="Paste the full verse here."></textarea>

      <div id="keyHiddenNote" class="keyHiddenNote" style="display:none;">
        ü´£ Verse source hidden. Click <b>Show</b> to view it.
      </div>

      <hr class="softRule" />

      <!-- Practice -->
      <div class="practiceRow">
        <div class="keyLabel">
          Say it out loud <span class="emojiSpeak">üó£Ô∏è</span>
          <button type="button" class="helpToggle" id="helpToggle" aria-expanded="false" aria-controls="helpTooltip">‚ìò</button>
        </div>

        <div class="btnRow">
          <button id="togglePractice" type="button">Show</button>
          <button id="toggleInitials" type="button" class="miniBtn">Hide initials</button>
          <button id="clearInitials" type="button" class="miniBtn">Clear initials</button>
        </div>
      </div>

      <div class="helpTooltip" id="helpTooltip" hidden>
        <strong>A gentle reminder~</strong><br>
        <span class="garamond-text">
          This isn‚Äôt a test. Pause, restart, or peek at the initials anytime.
          The goal is simply to spend time with God‚Äôs Word.
        </span>
      </div>

      <div id="practiceWrap" style="display:none;">
        <div class="revealInstructions">
          Recite the verse out loud. As you speak, type the initials to reveal the verse below.
        </div>

        <input
          class="revealInput"
          id="revealInput"
          placeholder="Type initials as you speak"
          autocomplete="off"
          autocapitalize="off"
          autocorrect="off"
          spellcheck="false"
          inputmode="text"
        />

        <div class="revealHint" id="revealHint"></div>
        <div class="revealLine" id="revealLine"></div>

        <div class="reflectionPrompt" id="reflectionPrompt">
          <span class="star">‚ú¶</span><em></em>
        </div>
      </div>

      <div id="practiceHiddenNote" class="keyHiddenNote">
        ü´£ Practice hidden. Click <b>Show</b> when ready to recite &amp; reveal.
      </div>

    </section>
  </div>

  <script>
    /* Reflection prompts: Families + lightweight verse-aware routing (no AI) */
    const QUESTION_FAMILIES = {
      attributes: {
        label: "God‚Äôs Nature & Attributes",
        questions: [
          "What does this reveal about God‚Äôs character or nature?",
          "What does this show about God‚Äôs faithfulness or reliability?",
          "What does this verse assume is already true about God?",
          "What false idea about God does this verse correct or rule out?",
          "What aspect of God feels weighty or emphasized here?"
        ]
      },

      authority_holiness: {
        label: "Authority, Rule, & Holiness",
        questions: [
          "How does this verse show God‚Äôs authority or rightful rule?",
          "In what way does this verse reflect God‚Äôs holiness or distinctness?",
          "Where do you see the Creator‚Äìcreature distinction upheld here?",
          "What response does God‚Äôs authority rightly call for in this verse?"
        ]
      },

      covenant_promise: {
        label: "Promise, Covenant, & Hope",
        questions: [
          "What promise is stated, implied, or echoed here?",
          "What does this verse invite you to trust God for?",
          "What future hope is grounded in this verse?",
          "How does this verse stabilize faith in uncertainty?"
        ]
      },

      christological: {
        label: "Christological Trajectory",
        questions: [
          "How does this point to Christ?",
          "How is Christ foreshadowed, revealed, or clarified here?",
          "What role of Christ is hinted at here (prophet, priest, king, shepherd, sacrifice)?",
          "How would this verse sound incomplete without Christ?"
        ]
      },

      human_response: {
        label: "Humanity & Response",
        questions: [
          "What does this verse reveal about humanity?",
          "What does this expose about the human heart?",
          "What response does this verse call for?",
          "What would obedience look like in ordinary life today?"
        ]
      },

      truth_vs_distortion: {
        label: "Truth vs. Distortion",
        questions: [
          "What false belief does this verse confront?",
          "What lie does this verse gently dismantle?",
          "What assumption (cultural or personal) does this challenge?",
          "What does this verse refuse to let us believe?"
        ]
      }
    };

    const ROUTING_RULES = [
      {
        family: "christological",
        keywords: [
          "christ","jesus","messiah","son","cross","blood","lamb",
          "gospel","resurrection","mediator","redeem","ransom","save",
          "salvation","grace","aton","propiti"
        ],
        weight: 3
      },
      {
        family: "covenant_promise",
        keywords: [
          "i will","shall","promise","covenant","forever","never",
          "with you","deliver","restore","bless","comfort","inherit"
        ],
        weight: 3
      },
      {
        family: "authority_holiness",
        keywords: [
          "do not","do ","go ","keep","obey","remember","command",
          "statute","law","ordinance","fear","holy","sanctif","clean"
        ],
        weight: 2
      },
      {
        family: "attributes",
        keywords: [
          "i am","i am the lord","yahweh","lord","name",
          "merciful","gracious","steadfast","faithful","good","just",
          "righteous","almighty","compassion"
        ],
        weight: 2
      },
      {
        family: "human_response",
        keywords: [
          "repent","believe","love","forgive","humble","seek","pray",
          "confess","walk","follow","trust"
        ],
        weight: 2
      },
      {
        family: "truth_vs_distortion",
        keywords: [
          "idols","vain","false","lie","deceiv","darkness",
          "exchange","no other","not "
        ],
        weight: 1
      }
    ];

    function normalize(text){
      return (text || "")
        .toLowerCase()
        .replace(/\s+/g, " ")
        .trim();
    }

    function pickRandom(arr){
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function chooseFamiliesForVerse(verseText, { allowTwo = true } = {}){
      const v = normalize(verseText);

      const scores = Object.fromEntries(
        Object.keys(QUESTION_FAMILIES).map(k => [k, 0])
      );

      for(const rule of ROUTING_RULES){
        let hits = 0;
        for(const kw of rule.keywords){
          const needle = normalize(kw);
          if(v.includes(needle)) hits++;
        }
        if(hits > 0) scores[rule.family] += hits * (rule.weight ?? 1);
      }

      const ranked = Object.entries(scores)
        .sort((a,b)=>b[1]-a[1])
        .map(([family, score]) => ({ family, score }));

      const top = ranked[0];
      const second = ranked[1];

      if(!top || top.score === 0){
        return { families: Object.keys(QUESTION_FAMILIES), reason: "fallback_all" };
      }

      if(
        allowTwo &&
        second &&
        second.score > 0 &&
        second.score >= Math.max(1, Math.floor(top.score * 0.8))
      ){
        return { families: [top.family, second.family], reason: "tie_or_close" };
      }

      return { families: [top.family], reason: "top_match" };
    }

    function getPromptForVerse(verseText, opts = {}){
      const { families } = chooseFamiliesForVerse(verseText, opts);
      const pool = families.flatMap(f => QUESTION_FAMILIES[f]?.questions || []);
      return pool.length ? pickRandom(pool) : "What stands out to you in this verse?";
    }

    /* State */
    let revealModel = null;
    let keyHidden = false;
    let practiceHidden = true;
    let practiceArmed = false;
    let initialsHidden = false;

    /* Shared verse cleaning */
    function extractCleanVerseText(raw){
      const text = (raw || "").trim();
      const quoted = text.match(/[‚Äú"]([^‚Äù"]+)[‚Äù"]/);

      const cleaned = quoted ? quoted[1] :
        text
          .replace(/https?:\/\/\S+/gi,"")
          .replace(/\b(?:ESV|NIV|NASB|KJV|NKJV|CSB|NLT)\b/gi,"")
          .replace(/\b[A-Za-z]+\s+\d+:\d+\b/g,"")
          .replace(/\b[a-z]\b/gi,"")
          .trim();

      return cleaned;
    }

    /* Build model */
    function buildRevealModel(text){
      const raw = (text || "").trim();

      const quoted = raw.match(/[‚Äú"]([^‚Äù"]+)[‚Äù"]/);
      const cleaned = quoted ? quoted[1] :
        raw
          .replace(/https?:\/\/\S+/gi,"")
          .replace(/\b(?:ESV|NIV|NASB|KJV|NKJV|CSB|NLT)\b/gi,"")
          .replace(/\b[A-Za-z]+\s+\d+:\d+\b/g,"")
          .replace(/\b[a-z]\b/gi,"")   // removes standalone footnote letters like a, b, c
          .trim();

      const words = cleaned.split(/\s+/)
        .map(w => w.replace(/^[^a-zA-Z]+|[^a-zA-Z]+$/g,""))
        .filter(Boolean);

      return {
        tokens: words.map((w,i)=>({i,display:w,initial:w[0].toLowerCase()})),
        initials: words.map(w=>w[0].toUpperCase()).join(" "),
        state:{cursor:0,revealed:Array(words.length).fill(false)}
      };
    }

    /* DOM */
    const fullVerseKey = document.getElementById("fullVerseKey");
    const toggleKey = document.getElementById("toggleKey");
    const keyHiddenNote = document.getElementById("keyHiddenNote");
    const clearSource = document.getElementById("clearSource");

    const togglePractice = document.getElementById("togglePractice");
    const practiceWrap = document.getElementById("practiceWrap");
    const practiceHiddenNote = document.getElementById("practiceHiddenNote");

    const revealInput = document.getElementById("revealInput");
    const revealHint = document.getElementById("revealHint");
    const revealLine = document.getElementById("revealLine");

    const clearInitials = document.getElementById("clearInitials");
    const toggleInitials = document.getElementById("toggleInitials");
    const reflectionPrompt = document.querySelector("#reflectionPrompt em");
    const helpToggle = document.getElementById("helpToggle");
    const helpTooltip = document.getElementById("helpTooltip");

    helpToggle.addEventListener("click", () => {
      const nextHidden = !helpTooltip.hidden;
      helpTooltip.hidden = nextHidden;
      helpToggle.setAttribute("aria-expanded", String(!nextHidden));
    });

    /* Helpers */
    function setKeyHidden(h){
      keyHidden=h;
      fullVerseKey.style.display=h?"none":"block";
      keyHiddenNote.style.display=h?"block":"none";
      toggleKey.textContent=h?"Show":"Hide";
    }

    function setPracticeHidden(h){
      practiceHidden=h;
      practiceWrap.style.display=h?"none":"block";
      practiceHiddenNote.style.display=h?"block":"none";
      togglePractice.textContent=h?"Show":"Hide";

      if (h) {
        helpTooltip.hidden = true;
        helpToggle.setAttribute("aria-expanded", "false");
      }
    }

    function render(){
      if(!practiceArmed || !revealModel){
        revealHint.textContent="";
        revealLine.textContent="";
        return;
      }

      revealHint.textContent = initialsHidden ? "" : `Initials: ${revealModel.initials}`;

      revealLine.innerHTML = revealModel.tokens.map((t,i)=>{
        const shown=revealModel.state.revealed[i];
        return `<span class="revealWord ${shown?"revealed":"hidden"}">${
          shown?t.display:"‚Ä¢".repeat(Math.max(3,t.display.length))
        }</span>`;
      }).join(" ");
    }

    /* Events */
    fullVerseKey.addEventListener("input",()=>{
      revealModel = buildRevealModel(fullVerseKey.value);
      practiceArmed=false;
      setPracticeHidden(true);

      if(!practiceHidden){
        const verseText = extractCleanVerseText(fullVerseKey.value);
        reflectionPrompt.textContent = getPromptForVerse(verseText);
      }
    });

    toggleKey.addEventListener("click",()=>setKeyHidden(!keyHidden));

    clearSource.addEventListener("click",()=>{
      fullVerseKey.value="";
      revealModel=null;
      practiceArmed=false;
      setKeyHidden(false);
      setPracticeHidden(true);
      revealInput.value="";
      reflectionPrompt.textContent="";
      render();
      fullVerseKey.focus();
    });

    togglePractice.addEventListener("click",()=>{
      const show = practiceHidden;
      setPracticeHidden(!practiceHidden);
      if(show){
        practiceArmed=true;

        const verseText = extractCleanVerseText(fullVerseKey.value);
        reflectionPrompt.textContent = getPromptForVerse(verseText);

        render();
        revealInput.focus();
      }
    });

    toggleInitials.addEventListener("click",()=>{
      initialsHidden=!initialsHidden;
      toggleInitials.textContent=initialsHidden?"Show initials":"Hide initials";
      render();
    });

    revealInput.addEventListener("input",()=>{
      if(!practiceArmed || !revealModel) return;
      const letters = revealInput.value.toLowerCase().match(/[a-z]/g)||[];
      revealModel.state.cursor=0;
      revealModel.state.revealed.fill(false);
      for(const ch of letters){
        const i=revealModel.state.cursor;
        if(ch===revealModel.tokens[i]?.initial){
          revealModel.state.revealed[i]=true;
          revealModel.state.cursor++;
        } else break;
      }
      render();
    });

    clearInitials.addEventListener("click",()=>{
      if(!practiceArmed) return;

      revealInput.value="";
      if(revealModel){
        revealModel.state.cursor=0;
        revealModel.state.revealed.fill(false);
      }
      render();
      revealInput.focus();
    });

    /* Init */
    setKeyHidden(false);
    setPracticeHidden(true);
    toggleInitials.textContent="Hide initials";
    render();
  </script>
</body>
</html>
